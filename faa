--// SERVICES
local Players = game:GetService("Players")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

-- update HRP on respawn
LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart")
end)

-- your mobs folder
local MOBS_FOLDER = workspace:WaitForChild("Scriptable"):WaitForChild("Mobs")

-- bigger radius to catch all nearby mobs
local CLUSTER_RADIUS = 35
local BEHIND_OFFSET = CFrame.new(0, 0, 3)

---------------------------------------------------------------------
-- GUI CREATION (clean rounded GUI + dropdown)
---------------------------------------------------------------------
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

local gui = Instance.new("ScreenGui")
gui.Name = "MobClusterGui"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 260, 0, 380)
frame.Position = UDim2.new(0, 20, 0, 150)
frame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
frame.BorderSizePixel = 0
frame.Parent = gui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 8)
frameCorner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 36)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.Text = "Mob Clusters"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = frame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = title

local dropdown = Instance.new("TextButton")
dropdown.Size = UDim2.new(1, -20, 0, 32)
dropdown.Position = UDim2.new(0, 10, 0, 46)
dropdown.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
dropdown.TextColor3 = Color3.fromRGB(255, 255, 255)
dropdown.Font = Enum.Font.GothamSemibold
dropdown.TextScaled = true
dropdown.Text = "Select Cluster"
dropdown.Parent = frame

local ddCorner = Instance.new("UICorner")
ddCorner.CornerRadius = UDim.new(0, 6)
ddCorner.Parent = dropdown

local dropdownList = Instance.new("ScrollingFrame")
dropdownList.Size = UDim2.new(1, -20, 0, 200)
dropdownList.Position = UDim2.new(0, 10, 0, 86)
dropdownList.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
dropdownList.BorderSizePixel = 0
dropdownList.Visible = false
dropdownList.ScrollBarThickness = 4
dropdownList.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownList.CanvasSize = UDim2.new()
dropdownList.Parent = frame

local ddListCorner = Instance.new("UICorner")
ddListCorner.CornerRadius = UDim.new(0, 6)
ddListCorner.Parent = dropdownList

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = dropdownList

local startBtn = Instance.new("TextButton")
startBtn.Size = UDim2.new(1, -20, 0, 40)
startBtn.Position = UDim2.new(0, 10, 0, 300)
startBtn.BackgroundColor3 = Color3.fromRGB(40, 140, 60)
startBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
startBtn.Font = Enum.Font.GothamBold
startBtn.TextScaled = true
startBtn.Text = "START"
startBtn.Parent = frame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 6)
startCorner.Parent = startBtn

local stopBtn = Instance.new("TextButton")
stopBtn.Size = UDim2.new(1, -20, 0, 40)
stopBtn.Position = UDim2.new(0, 10, 0, 345)
stopBtn.BackgroundColor3 = Color3.fromRGB(170, 40, 40)
stopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
stopBtn.Font = Enum.Font.GothamBold
stopBtn.TextScaled = true
stopBtn.Text = "STOP"
stopBtn.Parent = frame

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 6)
stopCorner.Parent = stopBtn

-- simple drag
local dragging = false
local dragStart, startPos
frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = frame.Position
	end
end)
frame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)
game:GetService("UserInputService").InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)

---------------------------------------------------------------------
-- MOB HELPERS
---------------------------------------------------------------------
local function getHP(mob)
	local folder = mob:FindFirstChild("PVPFolder")
	if not folder then return nil end
	return folder:FindFirstChild("NewHealth")
end

local function getRoot(mob)
	return mob:FindFirstChild("HumanoidRootPart")
end

local function getLivingMobs()
	local list = {}
	for _, mob in ipairs(MOBS_FOLDER:GetChildren()) do
		local hp = getHP(mob)
		local root = getRoot(mob)
		if hp and root and hp.Value > 0 then
			table.insert(list, mob)
		end
	end
	return list
end

---------------------------------------------------------------------
-- CLUSTER CALCULATION (distance-only)
---------------------------------------------------------------------
local function computeClusters()
	local mobs = getLivingMobs()
	local groups = {}

	for _, mob in ipairs(mobs) do
		local root = getRoot(mob)
		if not root then
			continue
		end

		local placed = false

		for _, grp in ipairs(groups) do
			for _, gm in ipairs(grp) do
				local gRoot = getRoot(gm)
				if gRoot and (root.Position - gRoot.Position).Magnitude <= CLUSTER_RADIUS then
					table.insert(grp, mob)
					placed = true
					break
				end
			end
			if placed then break end
		end

		if not placed then
			table.insert(groups, {mob})
		end
	end

	-- Convert to cluster info {center=Vector3, size=int}
	local clusters = {}
	for _, grp in ipairs(groups) do
		local sum = Vector3.new()
		local count = 0
		for _, mob in ipairs(grp) do
			local r = getRoot(mob)
			if r then
				sum += r.Position
				count += 1
			end
		end
		if count > 0 then
			table.insert(clusters, {
				center = sum / count,
				size = count
			})
		end
	end

	return clusters
end

---------------------------------------------------------------------
-- DROPDOWN LOGIC
---------------------------------------------------------------------
local selectedCluster = nil
local running = false

local function refreshDropdown()
	for _, child in ipairs(dropdownList:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end

	local clusters = computeClusters()

	for i, cl in ipairs(clusters) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 28)
		btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
		btn.TextColor3 = Color3.fromRGB(255, 255, 255)
		btn.Font = Enum.Font.Gotham
		btn.TextScaled = true
		btn.Text = string.format("Cluster %d  (%d mobs)", i, cl.size)
		btn.Parent = dropdownList

		local bc = Instance.new("UICorner")
		bc.CornerRadius = UDim.new(0, 4)
		bc.Parent = btn

		btn.MouseButton1Click:Connect(function()
			selectedCluster = cl
			dropdown.Text = btn.Text
			dropdownList.Visible = false
		end)
	end

	if not selectedCluster then
		dropdown.Text = #clusters > 0 and "Select Cluster" or "No clusters"
	end
end

dropdown.MouseButton1Click:Connect(function()
	dropdownList.Visible = not dropdownList.Visible
end)

---------------------------------------------------------------------
-- KILL LOGIC (handles new spawns in same area)
---------------------------------------------------------------------
local function killCluster(cluster)
	running = true

	while running do
		-- find all living mobs in this cluster area *right now*
		local living = {}
		for _, mob in ipairs(MOBS_FOLDER:GetChildren()) do
			local hp = getHP(mob)
			local root = getRoot(mob)
			if hp and root and hp.Value > 0 then
				if (root.Position - cluster.center).Magnitude <= CLUSTER_RADIUS then
					table.insert(living, mob)
				end
			end
		end

		-- no more mobs in this cluster zone
		if #living == 0 then
			break
		end

		-- kill each of the current mobs
		for _, mob in ipairs(living) do
			if not running then break end

			local hp = getHP(mob)
			local root = getRoot(mob)
			if not hp or not root or hp.Value <= 0 then
				continue
			end

			local timeout = tick() + 12

			while running do
				hp = getHP(mob)
				root = getRoot(mob)

				if not hp or hp.Value <= 0 or not root then
					break
				end

				if not HRP then
					local ch = LocalPlayer.Character
					if ch then
						HRP = ch:FindFirstChild("HumanoidRootPart")
					end
				end

				if HRP then
					HRP.CFrame = root.CFrame * BEHIND_OFFSET
				end

				if tick() > timeout then
					break
				end

				task.wait()
			end
		end
	end

	running = false
end

startBtn.MouseButton1Click:Connect(function()
	if selectedCluster and not running then
		killCluster(selectedCluster)
	end
end)

stopBtn.MouseButton1Click:Connect(function()
	running = false
end)

---------------------------------------------------------------------
-- AUTO-REFRESH CLUSTERS FOREVER
---------------------------------------------------------------------
task.spawn(function()
	while true do
		refreshDropdown()
		task.wait(1) -- update faster so new mobs show quickly
	end
end)
