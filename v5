--================================================== 
--  CLUSTER FARM GUI - workspace.Scriptable.Mobs
--  Infinite detection (name + moving anchor), sorted, futuristic UI
--==================================================

--// SERVICES
local Players = game:GetService("Players")
local UIS     = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Character   = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP         = Character:WaitForChild("HumanoidRootPart")

-- Folder: workspace.Scriptable.Mobs
local Scriptable  = workspace:WaitForChild("Scriptable")
local MOBS_FOLDER = Scriptable:WaitForChild("Mobs")

-- Radius for cluster area
local CLUSTER_RADIUS = 80
local BEHIND_OFFSET  = CFrame.new(0, 0, 3)

--==================================================
--  CHARACTER / HRP HANDLING (SURVIVES DEATH)
--==================================================

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart")
end)

local function ensureHRP()
    if HRP and HRP.Parent then
        return HRP
    end

    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    end

    HRP = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart")
    return HRP
end

--==================================================
--  GUI CREATION (futuristic, rounded, draggable)
--==================================================
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

local gui = Instance.new("ScreenGui")
gui.Name = "MobClusterGui"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 280, 0, 410)
frame.Position = UDim2.new(0, 30, 0, 140)
frame.BackgroundColor3 = Color3.fromRGB(8, 8, 12)
frame.BorderSizePixel = 0
frame.Active = true
frame.Parent = gui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 14)
frameCorner.Parent = frame

local frameStroke = Instance.new("UIStroke")
frameStroke.Color = Color3.fromRGB(90, 150, 255)
frameStroke.Thickness = 1.8
frameStroke.Transparency = 0.15
frameStroke.Parent = frame

local frameGradient = Instance.new("UIGradient")
frameGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(10, 10, 20)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(18, 24, 48))
})
frameGradient.Rotation = 45
frameGradient.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 38)
title.Position = UDim2.new(0, 10, 0, 8)
title.BackgroundTransparency = 1
title.Text = "Mob Groups"
title.TextColor3 = Color3.fromRGB(220, 230, 255)
title.Font = Enum.Font.GothamSemibold
title.TextScaled = true
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(1, -20, 0, 18)
subtitle.Position = UDim2.new(0, 10, 0, 42)
subtitle.BackgroundTransparency = 1
subtitle.Text = "Select a cluster to auto-farm"
subtitle.TextColor3 = Color3.fromRGB(150, 170, 220)
subtitle.Font = Enum.Font.Gotham
subtitle.TextScaled = true
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = frame

local dropdown = Instance.new("TextButton")
dropdown.Size = UDim2.new(1, -20, 0, 32)
dropdown.Position = UDim2.new(0, 10, 0, 70)
dropdown.BackgroundColor3 = Color3.fromRGB(20, 26, 50)
dropdown.TextColor3 = Color3.fromRGB(230, 236, 255)
dropdown.Font = Enum.Font.GothamSemibold
dropdown.TextScaled = true
dropdown.Text = "Select Group"
dropdown.AutoButtonColor = false
dropdown.Parent = frame

local ddCorner = Instance.new("UICorner")
ddCorner.CornerRadius = UDim.new(0, 10)
ddCorner.Parent = dropdown

local ddStroke = Instance.new("UIStroke")
ddStroke.Color = Color3.fromRGB(90, 150, 255)
ddStroke.Thickness = 1.3
ddStroke.Transparency = 0.2
ddStroke.Parent = dropdown

local dropdownList = Instance.new("ScrollingFrame")
dropdownList.Size = UDim2.new(1, -20, 0, 220)
dropdownList.Position = UDim2.new(0, 10, 0, 110)
dropdownList.BackgroundColor3 = Color3.fromRGB(10, 12, 26)
dropdownList.BorderSizePixel = 0
dropdownList.Visible = false
dropdownList.ScrollBarThickness = 4
dropdownList.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownList.CanvasSize = UDim2.new()
dropdownList.Parent = frame

local ddListCorner = Instance.new("UICorner")
ddListCorner.CornerRadius = UDim.new(0, 10)
ddListCorner.Parent = dropdownList

local ddListStroke = Instance.new("UIStroke")
ddListStroke.Color = Color3.fromRGB(70, 120, 220)
ddListStroke.Thickness = 1
ddListStroke.Transparency = 0.3
ddListStroke.Parent = dropdownList

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding   = UDim.new(0, 4)
layout.Parent    = dropdownList

local startBtn = Instance.new("TextButton")
startBtn.Size = UDim2.new(0.5, -15, 0, 40)
startBtn.Position = UDim2.new(0, 10, 0, 340)
startBtn.BackgroundColor3 = Color3.fromRGB(40, 180, 120)
startBtn.TextColor3 = Color3.fromRGB(240, 250, 255)
startBtn.Font = Enum.Font.GothamBold
startBtn.TextScaled = true
startBtn.Text = "START"
startBtn.AutoButtonColor = false
startBtn.Parent = frame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 10)
startCorner.Parent = startBtn

local stopBtn = Instance.new("TextButton")
stopBtn.Size = UDim2.new(0.5, -15, 0, 40)
stopBtn.Position = UDim2.new(0.5, 5, 0, 340)
stopBtn.BackgroundColor3 = Color3.fromRGB(190, 60, 80)
stopBtn.TextColor3 = Color3.fromRGB(255, 235, 240)
stopBtn.Font = Enum.Font.GothamBold
stopBtn.TextScaled = true
stopBtn.Text = "STOP"
stopBtn.AutoButtonColor = false
stopBtn.Parent = frame

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 10)
stopCorner.Parent = stopBtn

local function makeHover(btn, baseColor, hoverColor)
	btn.MouseEnter:Connect(function()
		btn.BackgroundColor3 = hoverColor
	end)
	btn.MouseLeave:Connect(function()
		btn.BackgroundColor3 = baseColor
	end)
end

makeHover(startBtn, Color3.fromRGB(40, 180, 120), Color3.fromRGB(60, 210, 150))
makeHover(stopBtn,  Color3.fromRGB(190, 60, 80),  Color3.fromRGB(220, 80, 100))
makeHover(dropdown, Color3.fromRGB(20, 26, 50),  Color3.fromRGB(30, 40, 70))

-- Simple dragging
local dragging, dragStart, startPos
frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging  = true
		dragStart = input.Position
		startPos  = frame.Position
	end
end)
frame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)
UIS.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)

--==================================================
--  MOB HELPERS (ONLY CHILDREN OF workspace.Scriptable.Mobs)
--==================================================
local function getRoot(mob)
	return mob:FindFirstChild("HumanoidRootPart")
end

local function getHumanoid(mob)
	return mob:FindFirstChildOfClass("Humanoid")
end

-- Return (hpNumber, objectUsed)
local function getHPValue(mob)
	local pvp = mob:FindFirstChild("PVPFolder")
	if pvp then
		local newHealth = pvp:FindChildWhichIsA("ValueBase")
		if newHealth and type(newHealth.Value) == "number" then
			return newHealth.Value, newHealth
		end
	end

	local hum = getHumanoid(mob)
	if hum then
		return hum.Health, hum
	end

	return nil, nil
end

local function getAllMobsInFolder()
	local list = {}
	for _, child in ipairs(MOBS_FOLDER:GetChildren()) do
		if getRoot(child) then
			table.insert(list, child)
		end
	end
	return list
end

--==================================================
--  CLUSTER BUILDING (distance only, sorted by mob number)
--==================================================
-- returns: { { center = Vector3, members = {...}, repName, repNumber }, ... }

local function buildClusters()
	local mobs = getAllMobsInFolder()
	local clusters = {}

	for _, mob in ipairs(mobs) do
		local root = getRoot(mob)
		if not root then
			continue
		end

		local placed = false

		for _, cluster in ipairs(clusters) do
			for _, other in ipairs(cluster.members) do
				local otherRoot = getRoot(other)
				if otherRoot and (root.Position - otherRoot.Position).Magnitude <= CLUSTER_RADIUS then
					table.insert(cluster.members, mob)
					placed = true
					break
				end
			end
			if placed then break end
		end

		if not placed then
			table.insert(clusters, {members = {mob}})
		end
	end

	for _, cluster in ipairs(clusters) do
		local sum = Vector3.new()
		local n   = 0
		for _, mob in ipairs(cluster.members) do
			local r = getRoot(mob)
			if r then
				sum += r.Position
				n += 1
			end
		end
		cluster.center = n > 0 and (sum / n) or nil

		local repName   = "Unknown"
		local repNumber = math.huge

		if cluster.members[1] and cluster.members[1].Name then
			repName = cluster.members[1].Name
			local num = tonumber(repName)
			if num then
				repNumber = num
			end
		end

		cluster.repName   = repName
		cluster.repNumber = repNumber
	end

	table.sort(clusters, function(a, b)
		return a.repNumber < b.repNumber
	end)

	return clusters
end

--==================================================
--  DROPDOWN + SELECTION
--==================================================
local clusters = {}
local selectedConfig = nil
local running = false

local function refreshDropdown()
	for _, child in ipairs(dropdownList:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end

	clusters = buildClusters()

	for _, cluster in ipairs(clusters) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 28)
		btn.BackgroundColor3 = Color3.fromRGB(18, 22, 40)
		btn.TextColor3 = Color3.fromRGB(220, 230, 255)
		btn.Font = Enum.Font.Gotham
		btn.TextScaled = true
		btn.AutoButtonColor = false

		local repName = cluster.repName or "Unknown"
		btn.Text = string.format("%s  (%d mobs)", repName, #cluster.members)
		btn.Parent = dropdownList

		local bc = Instance.new("UICorner")
		bc.CornerRadius = UDim.new(0, 8)
		bc.Parent = btn

		local bStroke = Instance.new("UIStroke")
		bStroke.Color = Color3.fromRGB(60, 100, 200)
		bStroke.Thickness = 1
		bStroke.Transparency = 0.5
		bStroke.Parent = btn

		makeHover(btn, Color3.fromRGB(18, 22, 40), Color3.fromRGB(30, 36, 66))

		btn.MouseButton1Click:Connect(function()
			-- lock to this mob name + starting center (anchor)
			selectedConfig = {
				repName  = cluster.repName,
				anchor   = cluster.center,
			}
			dropdown.Text = btn.Text
			dropdownList.Visible = false
		end)
	end

	if not selectedConfig then
		if #clusters > 0 then
			dropdown.Text = "Select Group"
		else
			dropdown.Text = "No groups"
		end
	end
end

dropdown.MouseButton1Click:Connect(function()
	dropdownList.Visible = not dropdownList.Visible
end)

--==================================================
--  STABLE DETECTION AROUND MOVING ANCHOR
--==================================================

local function getLivingInConfig(cfg)
	local living = {}
	if not cfg or not cfg.anchor or not cfg.repName then return living end

	for _, mob in ipairs(MOBS_FOLDER:GetChildren()) do
		if mob.Name == cfg.repName then
			local root = getRoot(mob)
			if root then
				local dist = (root.Position - cfg.anchor).Magnitude
				if dist <= CLUSTER_RADIUS * 1.5 then
					local hpVal = getHPValue(mob)
					if hpVal and hpVal > 0 then
						table.insert(living, mob)
					end
				end
			end
		end
	end

	-- update anchor to follow the pack (center of current living)
	if #living > 0 then
		local sum = Vector3.new()
		local n = 0
		for _, mob in ipairs(living) do
			local r = getRoot(mob)
			if r then
				sum += r.Position
				n += 1
			end
		end
		if n > 0 then
			cfg.anchor = sum / n
		end
	end

	return living
end

--==================================================
--  KILL LOGIC (infinite detection + survives death)
--==================================================

local function killConfig(cfg)
	if not cfg then return end
	running = true

	while running do
		local living = getLivingInConfig(cfg)

		if #living == 0 then
			-- üîÅ NO BREAK: just keep scanning forever for respawns
			task.wait(0.25)
		else
			for _, mob in ipairs(living) do
				if not running then break end

				local timeout = tick() + 12

				while running do
					if not mob or mob.Parent ~= MOBS_FOLDER then
						break
					end

					local root  = getRoot(mob)
					local hpVal = getHPValue(mob)

					if not root or not hpVal or hpVal <= 0 then
						break
					end

					local hrp = ensureHRP()
					if hrp then
						hrp.CFrame = root.CFrame * BEHIND_OFFSET
					end

					if tick() > timeout then
						break
					end

					task.wait()
				end
			end
		end
	end

	running = false
end

startBtn.MouseButton1Click:Connect(function()
	if selectedConfig and not running then
		killConfig(selectedConfig)
	end
end)

stopBtn.MouseButton1Click:Connect(function()
	running = false
end)

--==================================================
--  AUTO-REFRESH GROUPS FOREVER (for GUI only)
--==================================================
task.spawn(function()
	while true do
		refreshDropdown()
		task.wait(0.5)
	end
end)
