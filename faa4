--==================================================
--  ABSOLUTE GROUP FARM GUI - workspace.Scriptable.Mobs
--==================================================

--// SERVICES
local Players = game:GetService("Players")
local UIS     = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Character   = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP         = Character:WaitForChild("HumanoidRootPart")

-- Folder: workspace.Scriptable.Mobs
local Scriptable  = workspace:WaitForChild("Scriptable")
local MOBS_FOLDER = Scriptable:WaitForChild("Mobs")

-- Radius for grouping mobs into a "group"
local CLUSTER_RADIUS = 80
local BEHIND_OFFSET  = CFrame.new(0, 0, 3)

--==================================================
--  CHARACTER / HRP HANDLING (SURVIVES DEATH)
--==================================================

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart")
end)

-- Always return a valid HRP, waiting through respawn if necessary
local function ensureHRP()
    if HRP and HRP.Parent then
        return HRP
    end

    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    end

    HRP = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart")
    return HRP
end

-- Simple array copy (so selection is absolute)
local function cloneArray(t)
    local new = {}
    for i, v in ipairs(t) do
        new[i] = v
    end
    return new
end

--==================================================
--  GUI CREATION (clean, rounded, draggable)
--==================================================
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

local gui = Instance.new("ScreenGui")
gui.Name = "MobGroupGui"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 260, 0, 380)
frame.Position = UDim2.new(0, 20, 0, 150)
frame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
frame.BorderSizePixel = 0
frame.Active = true
frame.Parent = gui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 8)
frameCorner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 36)
title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
title.Text = "Mob Groups"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = frame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = title

local dropdown = Instance.new("TextButton")
dropdown.Size = UDim2.new(1, -20, 0, 32)
dropdown.Position = UDim2.new(0, 10, 0, 46)
dropdown.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
dropdown.TextColor3 = Color3.fromRGB(255, 255, 255)
dropdown.Font = Enum.Font.GothamSemibold
dropdown.TextScaled = true
dropdown.Text = "Select Group"
dropdown.Parent = frame

local ddCorner = Instance.new("UICorner")
ddCorner.CornerRadius = UDim.new(0, 6)
ddCorner.Parent = dropdown

local dropdownList = Instance.new("ScrollingFrame")
dropdownList.Size = UDim2.new(1, -20, 0, 200)
dropdownList.Position = UDim2.new(0, 10, 0, 86)
dropdownList.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
dropdownList.BorderSizePixel = 0
dropdownList.Visible = false
dropdownList.ScrollBarThickness = 4
dropdownList.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownList.CanvasSize = UDim2.new()
dropdownList.Parent = frame

local ddListCorner = Instance.new("UICorner")
ddListCorner.CornerRadius = UDim.new(0, 6)
ddListCorner.Parent = dropdownList

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding   = UDim.new(0, 4)
layout.Parent    = dropdownList

local startBtn = Instance.new("TextButton")
startBtn.Size = UDim2.new(1, -20, 0, 40)
startBtn.Position = UDim2.new(0, 10, 0, 300)
startBtn.BackgroundColor3 = Color3.fromRGB(40, 140, 60)
startBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
startBtn.Font = Enum.Font.GothamBold
startBtn.TextScaled = true
startBtn.Text = "START"
startBtn.Parent = frame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 6)
startCorner.Parent = startBtn

local stopBtn = Instance.new("TextButton")
stopBtn.Size = UDim2.new(1, -20, 0, 40)
stopBtn.Position = UDim2.new(0, 10, 0, 345)
stopBtn.BackgroundColor3 = Color3.fromRGB(170, 40, 40)
stopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
stopBtn.Font = Enum.Font.GothamBold
stopBtn.TextScaled = true
stopBtn.Text = "STOP"
stopBtn.Parent = frame

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 6)
stopCorner.Parent = stopBtn

-- Simple dragging
local dragging, dragStart, startPos
frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging  = true
		dragStart = input.Position
		startPos  = frame.Position
	end
end)
frame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)
UIS.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)

--==================================================
--  MOB HELPERS (ONLY CHILDREN OF workspace.Scriptable.Mobs)
--==================================================
local function getRoot(mob)
	return mob:FindFirstChild("HumanoidRootPart")
end

local function getHPObject(mob)
	local pvp = mob:FindFirstChild("PVPFolder")
	if not pvp then return nil end
	return pvp:FindFirstChild("NewHealth")
end

local function getHPValue(mob)
	local hpObj = getHPObject(mob)
	if hpObj and type(hpObj.Value) == "number" then
		return hpObj.Value
	end
	return nil
end

local function getAllMobsInFolder()
	local list = {}
	for _, child in ipairs(MOBS_FOLDER:GetChildren()) do
		if getRoot(child) then
			table.insert(list, child)
		end
	end
	return list
end

--==================================================
--  GROUP BUILDING (distance only)
--==================================================
-- returns: { { center = Vector3, members = {mob1,mob2,...}, repName, repNumber }, ... }

local function buildGroups()
	local mobs = getAllMobsInFolder()
	local groups = {}

	for _, mob in ipairs(mobs) do
		local root = getRoot(mob)
		if not root then
			continue
		end

		local placed = false

		for _, group in ipairs(groups) do
			for _, other in ipairs(group.members) do
				local otherRoot = getRoot(other)
				if otherRoot and (root.Position - otherRoot.Position).Magnitude <= CLUSTER_RADIUS then
					table.insert(group.members, mob)
					placed = true
					break
				end
			end
			if placed then break end
		end

		if not placed then
			table.insert(groups, {members = {mob}})
		end
	end

	for _, group in ipairs(groups) do
		-- center (we don't really need for absolute selection anymore, but keep in case)
		local sum = Vector3.new()
		local n   = 0
		for _, mob in ipairs(group.members) do
			local r = getRoot(mob)
			if r then
				sum += r.Position
				n += 1
			end
		end
		group.center = n > 0 and (sum / n) or nil

		-- representative name & numeric sort key
		local repName = "Unknown"
		local repNum = math.huge

		if group.members[1] and group.members[1].Name then
			repName = group.members[1].Name
			local nName = tonumber(repName)
			if nName then
				repNum = nName
			end
		end

		group.repName   = repName
		group.repNumber = repNum
	end

	-- sort groups by repNumber (least to greatest)
	table.sort(groups, function(a,b)
		return a.repNumber < b.repNumber
	end)

	return groups
end

--==================================================
--  DROPDOWN + SELECTION
--==================================================
local groups = {}
local selectedGroupIndex = nil
local selectedGroupMobs = nil
local running = false

local function refreshDropdown()
	for _, child in ipairs(dropdownList:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end

	groups = buildGroups()

	for i, group in ipairs(groups) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 28)
		btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
		btn.TextColor3 = Color3.fromRGB(255, 255, 255)
		btn.Font = Enum.Font.Gotham
		btn.TextScaled = true

		-- label: mob name (number) + count
		local repName = group.repName or "Unknown"
		btn.Text = string.format("%s (%d mobs)", repName, #group.members)
		btn.Parent = dropdownList

		local bc = Instance.new("UICorner")
		bc.CornerRadius = UDim.new(0, 4)
		bc.Parent = btn

		btn.MouseButton1Click:Connect(function()
			selectedGroupIndex = i
			-- absolute selection: freeze this mob list right now
			selectedGroupMobs = cloneArray(group.members)
			dropdown.Text = btn.Text
			dropdownList.Visible = false
		end)
	end

	if not selectedGroupIndex then
		if #groups > 0 then
			dropdown.Text = "Select Group"
		else
			dropdown.Text = "No groups"
		end
	end
end

dropdown.MouseButton1Click:Connect(function()
	dropdownList.Visible = not dropdownList.Visible
end)

--==================================================
--  KILL LOGIC (absolute selection, survives death)
--==================================================

local function killGroup(mobList)
	running = true

	for _, mob in ipairs(mobList) do
		if not running then break end

		-- skip if mob no longer in correct folder
		if not mob or mob.Parent ~= MOBS_FOLDER then
			continue
		end

		local root = getRoot(mob)
		local hpVal = getHPValue(mob)

		if not root or not hpVal or hpVal <= 0 then
			continue
		end

		-- stay on THIS mob until its NewHealth <= 0 or it disappears
		while running do
			if not mob or mob.Parent ~= MOBS_FOLDER then
				break
			end

			root = getRoot(mob)
			local hpObj = getHPObject(mob)
			if not root or not hpObj then
				break
			end

			if type(hpObj.Value) == "number" and hpObj.Value <= 0 then
				break
			end

			local hrp = ensureHRP()
			if hrp then
				hrp.CFrame = root.CFrame * BEHIND_OFFSET
			end

			task.wait()
		end
	end

	running = false
end

startBtn.MouseButton1Click:Connect(function()
	if selectedGroupMobs and not running then
		killGroup(selectedGroupMobs)
	end
end)

stopBtn.MouseButton1Click:Connect(function()
	running = false
end)

--==================================================
--  AUTO-REFRESH GROUPS FOREVER (just for GUI)
--==================================================
task.spawn(function()
	while true do
		-- this only changes the dropdown options;
		-- your active selection uses a fixed mob list (absolute)
		refreshDropdown()
		task.wait(0.75)
	end
end)
